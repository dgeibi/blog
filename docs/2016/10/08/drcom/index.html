<!DOCTYPE html><html lang="cmn-hans"><head><meta charset="utf-8"><title>Drcom 折腾记录 | dgeibi's blog</title><meta name="author" content="dgeibi"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta name="renderer" content="webkit|ie-comp|ie-stand"><link rel="stylesheet" href="/css/style.css"><link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml"><link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml"><link rel="canonical" href="https://blog.dgeibi.xyz/2016/10/08/drcom/index.html"><link rel="icon" type="image/png" href="/favicon.png"><link rel="apple-touch-icon" sizes="256x256" href="/favicon.png"><link rel="manifest" href="/manifest.json"><script src="/js/main.js" defer></script></head><body><header class="site-header"><div class="wrapper"><section class="site-title">dgeibi's blog</section><nav class="site-nav"><a class="nav-item" href="/">首页 </a><a class="nav-item" href="/archives/">归档 </a><a class="nav-item" href="/about/">关于 </a><a class="nav-item" href="/atom.xml">Feed </a></nav></div></header><main class="page-content"><div class="wrapper"><article class="post"><header class="post-header"><h1 class="post-title" itemprop="name headline">Drcom 折腾记录</h1><section class="meta">发表于 <time datetime="2016-10-08T21:36:17+08:00">2016-10-08</time>&nbsp;|&nbsp;修改于 <time datetime="2017-01-11T15:12:59+08:00">2017-01-11</time></section><section class="meta"></section><section class="meta">标签: &nbsp;<span><a href="/archives/tags/openwrt/">#OpenWrt</a></span>&nbsp;<span><a href="/archives/tags/network/">#网络</a></span></section></header><section id="toc"><h2 class="heading">Content</h2><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#可行性测试"><span class="toc-number">1.</span> <span class="toc-text">可行性测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#在-OpenWrt-上安装-Python-2"><span class="toc-number">2.</span> <span class="toc-text">在 OpenWrt 上安装 Python 2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#文件的准备与部署"><span class="toc-number">3.</span> <span class="toc-text">文件的准备与部署</span></a></li></ol></section><section class="post-content toc-src" itemprop="articleBody"><p>2016 年 10 月 8 日，校园网认证客户端换成了 drcom，版本为 5.2.1(p)。使用 Linux 的我不得不再折腾 :(</p>
<h2 id="可行性测试"><a href="#可行性测试" class="headerlink" title="可行性测试"></a>可行性测试</h2><p>首先，参考 <a href="https://github.com/drcoms/drcom-generic/wiki/p%E7%89%88%E7%AE%80%E7%95%A5%E4%BD%BF%E7%94%A8%E5%92%8C%E9%85%8D%E7%BD%AE%E8%AF%B4%E6%98%8E" target="_blank" rel="external">p 版简略使用和配置说明</a> 抓包，生成 <code>config.txt</code>，重命名为 <code>drcom.conf</code>。可是在 “PC 上测试” 那一步卡住，拨号失败了。</p>
<p>参考 <a href="https://github.com/drcoms/drcom-generic/wiki/%E5%85%B3%E4%BA%8EP%E7%89%88%E7%9A%84PPPoE%E6%8B%A8%E5%8F%B7%E9%97%AE%E9%A2%98" target="_blank" rel="external">关于 P 版的 PPPoE 拨号问题</a>，发现用户名（账号）前多了 <code>\r\n</code>，利用 wiki 中的方法让 PC/OpenWrt 成功拨号，连接上了，能够上网。</p>
<p>OpenWrt 下需要对 <code>/lib/netifd/proto/ppp.sh</code> 打补丁，运行以下命令即可。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line"><span class="meta">#!/bin/sh</span></div><div class="line">cp /lib/netifd/proto/ppp.sh /lib/netifd/proto/ppp.sh_bak</div><div class="line">sed -i <span class="string">'/proto_run_command/i username=`echo -e "$username"`'</span> /lib/netifd/proto/ppp.sh</div></pre></td></tr></table></figure>
<p>然而，这并不完美，PPPoE 每 1-2 分钟断开一次，所以需要继续折腾。可是，继续原来的教程，运行当时仓库的 python 脚本 latest-pppoe.py，一堆错误，认证失败了，该断的时候还是断了。翻了一下 <a href="https://github.com/drcoms/drcom-generic" target="_blank" rel="external">drcoms/drcom-generic</a> 的 closed Issues，发现很多和 5.2.1(p) 相关的 Issue，测试大大们提供的脚本，结果表明 <a href="https://github.com/drcoms/drcom-generic/issues/116#issuecomment-250953770" target="_blank" rel="external">Issue #116</a> 在我所在环境有效。值得注意的是所有的文件的换行字元都必须为 <code>LF</code>（Unix 的换行字元），不能是 <code>CRLF</code>（Windows 的换行字元），可用 <a href="https://code.visualstudio.com/" target="_blank" rel="external">Visual Studio Code</a>、<a href="https://atom.io/" target="_blank" rel="external">Atom</a> 等现代编辑器修改文件的换行字元。</p>
<p><strong>有些路由器可能一直不能成功拨号，我猜测是因为改过硬件，没有有效的 MAC</strong></p>
<p>解决方法：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">ssh root@192.168.1.1</div><div class="line">uci <span class="built_in">set</span> network.wan.macaddr=<span class="string">'xx:xx:xx:xx:xx:xx'</span></div><div class="line">uci commit network</div><div class="line">/etc/init.d/network reload</div></pre></td></tr></table></figure>
<p><code>xx:xx:xx:xx:xx:xx</code> 为 MAC 地址，可以用电脑的。这里有 <a href="http://aruljohn.com/mac/D864C75EF1C6" target="_blank" rel="external">查看电脑 MAC 地址的方法</a>。</p>
<h2 id="在-OpenWrt-上安装-Python-2"><a href="#在-OpenWrt-上安装-Python-2" class="headerlink" title="在 OpenWrt 上安装 Python 2"></a>在 OpenWrt 上安装 Python 2</h2><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">ssh root@192.168.1.1</div><div class="line">opkg update</div><div class="line"><span class="comment"># OpenWrt 15.05+</span></div><div class="line">opkg install python-light python-logging python-openssl python-codecs</div><div class="line"><span class="comment"># OpenWrt 14.07</span></div><div class="line">opkg install python-mini</div><div class="line"></div><div class="line"><span class="built_in">exit</span></div></pre></td></tr></table></figure>
<p>如果无法安装，则需要检查一下软件源。15.05 以上软件源信息在 <code>/etc/opkg/distfeeds.conf</code>，老版本的在 <code>/etc/opkg.conf</code>，根据以下格式修改之。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line"><span class="comment"># 15.05.1/ar71xx/generic 的软件源，ar71xx/generic 为硬件类型</span></div><div class="line">src/gz chaos_calmer_base http://openwrt.proxy.ustclug.org/chaos_calmer/15.05.1/ar71xx/generic/packages/base</div><div class="line">src/gz chaos_calmer_luci http://openwrt.proxy.ustclug.org/chaos_calmer/15.05.1/ar71xx/generic/packages/luci</div><div class="line">src/gz chaos_calmer_management http://openwrt.proxy.ustclug.org/chaos_calmer/15.05.1/ar71xx/generic/packages/management</div><div class="line">src/gz chaos_calmer_packages http://openwrt.proxy.ustclug.org/chaos_calmer/15.05.1/ar71xx/generic/packages/packages</div><div class="line">src/gz chaos_calmer_routing http://openwrt.proxy.ustclug.org/chaos_calmer/15.05.1/ar71xx/generic/packages/routing</div><div class="line">src/gz chaos_calmer_telephony http://openwrt.proxy.ustclug.org/chaos_calmer/15.05.1/ar71xx/generic/packages/telephony</div></pre></td></tr></table></figure>
<p>也可以自己编译带 Python 的固件，当然能够 <a href="/2016/10/12/build-openwrt-with-drcom/">编译自带 Drcom 的 OpenWrt 固件</a> 就更好了。</p>
<h2 id="文件的准备与部署"><a href="#文件的准备与部署" class="headerlink" title="文件的准备与部署"></a>文件的准备与部署</h2><p>以下文件需要放在相应的文件夹中，以方便部署。</p>
<p>etc/drcom.conf:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">server = &apos;10.0.3.2&apos;</div><div class="line">PPPoE_flag = &apos;\x6b&apos;</div><div class="line">keep_alive2_flag = &apos;\xdc&apos;</div></pre></td></tr></table></figure>
<p>经 <a href="https://github.com/drcoms/drcom-generic/issues/150" target="_blank" rel="external">Issue #150 · drcoms/drcom-generic</a> 提醒 drcom.conf 的 PPPoE_flag 更新了，奇怪的是通过上文提到的步骤抓出来的 PPPoE_flag 还是 <code>\x6a</code>。我没有验证过，因为我目前在用 C 写的 <a href="https://github.com/chenhaowen01/gdut-drcom-for-openwrt" target="_blank" rel="external">chenhaowen01/gdut-drcom-for-openwrt</a>。</p>
<p>usr/bin/drcom: 可用的 python 脚本，如 <a href="https://github.com/drcoms/drcom-generic/issues/116#issuecomment-250953770" target="_blank" rel="external">Issue #116</a> （将 <code>IS_TEST</code> 的值改为 <code>False</code>）。注：现在直接用仓库的最新的 <code>latest-pppoe.py</code> 就可以。</p>
<p>最后，需要让 python 脚本在 PPPoE 拨通后自动执行。需要额外的脚本，见下面的 99-drcom。其实，wiki 上就有，只是改了 wan 口的名称而已。</p>
<p>etc/hotplug.d/iface/99-drcom:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line"><span class="meta">#!/bin/sh</span></div><div class="line">[ <span class="string">"<span class="variable">$ACTION</span>"</span> = ifup ] || <span class="built_in">exit</span> 0</div><div class="line">[ <span class="string">"<span class="variable">$INTERFACE</span>"</span> = wan ] || <span class="built_in">exit</span> 0</div><div class="line">sleep 10</div><div class="line">/usr/bin/drcom</div></pre></td></tr></table></figure>
<p>赋予脚本可执行的权限，也可以在部署、ssh 登录后再做</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">chmod +x usr/bin/drcom</div></pre></td></tr></table></figure>
<p>将所有文件上传到 OpenWrt</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">scp -r usr etc root@192.168.1.1:/</div></pre></td></tr></table></figure>
</section></article></div></main><footer class="site-footer"><section><small>&copy; 2015-2017
 dgeibi <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a></small></section><section><small>Powered by <a href="https://hexo.io">Hexo</a>. Theme by <a href="https://github.com/dgeibi">dgeibi</a>.</small></section></footer><a class="back-to-top" data-js-backtotop href="#" title="Back to top">&uarr;</a></body></html>