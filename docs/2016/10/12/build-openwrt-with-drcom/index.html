<!DOCTYPE html><html lang="cmn-hans"><head><meta charset="utf-8"><title>编译自带 Drcom 的 OpenWrt 固件 | dgeibi's blog</title><meta name="author" content="dgeibi"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta name="renderer" content="webkit|ie-comp|ie-stand"><link rel="stylesheet" href="/css/style.css"><link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml"><link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml"><link rel="canonical" href="https://blog.dgeibi.xyz/2016/10/12/build-openwrt-with-drcom/index.html"><link rel="icon" type="image/png" href="/favicon.png"><link rel="apple-touch-icon" sizes="256x256" href="/favicon.png"><link rel="manifest" href="/manifest.json"><script src="/js/main.js" defer></script></head><body><header class="site-header"><div class="wrapper"><section class="site-title">dgeibi's blog</section><nav class="site-nav"><a class="nav-item" href="/">首页 </a><a class="nav-item" href="/archives/">归档 </a><a class="nav-item" href="/about/">关于 </a><a class="nav-item" href="/atom.xml">Feed </a></nav></div></header><main class="page-content"><div class="wrapper"><article class="post"><header class="post-header"><h1 class="post-title" itemprop="name headline">编译自带 Drcom 的 OpenWrt 固件</h1><section class="meta">发表于 <time datetime="2016-10-12T14:03:19+08:00">2016-10-12</time>&nbsp;|&nbsp;修改于 <time datetime="2017-01-11T16:07:31+08:00">2017-01-11</time></section><section class="meta"></section><section class="meta">标签: &nbsp;<span><a href="/archives/tags/openwrt/">#OpenWrt</a></span>&nbsp;<span><a href="/archives/tags/network/">#网络</a></span></section></header><section id="toc"><h2 class="heading">Content</h2><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#获取-Image-Builder"><span class="toc-number">1.</span> <span class="toc-text">获取 Image Builder</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#修改-repositories-conf"><span class="toc-number">2.</span> <span class="toc-text">修改 repositories.conf</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#安装-make-的依赖"><span class="toc-number">3.</span> <span class="toc-text">安装 make 的依赖</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#修改-Makefile"><span class="toc-number">4.</span> <span class="toc-text">修改 Makefile</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置文件的准备"><span class="toc-number">5.</span> <span class="toc-text">配置文件的准备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#编译固件"><span class="toc-number">6.</span> <span class="toc-text">编译固件</span></a></li></ol></section><section class="post-content toc-src" itemprop="articleBody"><p>感谢：</p>
<ul>
<li><a href="https://wiki.openwrt.org/doc/howto/obtain.firmware.generate" target="_blank" rel="external">Image Generator (Image Builder) - EN [OpenWrt Wiki]</a></li>
<li><a href="http://openwrt.proxy.ustclug.org/" target="_blank" rel="external">OpenWrt Downloads - 中科大镜像</a></li>
</ul>
<p>本文假定使用的路由器：GL-iNet 6416A v1，使用的 CPU：ar71xx/generic；OpenWrt：15.05.1；Drcom：5.2.1(p)。</p>
<h2 id="获取-Image-Builder"><a href="#获取-Image-Builder" class="headerlink" title="获取 Image Builder"></a>获取 Image Builder</h2><figure class="highlight bash"><table><tr><td class="code"><pre><div class="line"><span class="built_in">cd</span> ~</div><div class="line">mkdir openwrt &amp;&amp; <span class="built_in">cd</span> openwrt</div><div class="line">wget http://openwrt.proxy.ustclug.org/chaos_calmer/15.05.1/ar71xx/generic/OpenWrt-ImageBuilder-15.05.1-ar71xx-generic.Linux-x86_64.tar.bz2</div></pre></td></tr></table></figure>
<h2 id="修改-repositories-conf"><a href="#修改-repositories-conf" class="headerlink" title="修改 repositories.conf"></a>修改 repositories.conf</h2><p>修改 repositories.conf 如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">src/gz chaos_calmer_base http://openwrt.proxy.ustclug.org/chaos_calmer/15.05.1/ar71xx/generic/packages/base</div><div class="line">src/gz chaos_calmer_luci http://openwrt.proxy.ustclug.org/chaos_calmer/15.05.1/ar71xx/generic/packages/luci</div><div class="line">src/gz chaos_calmer_management http://openwrt.proxy.ustclug.org/chaos_calmer/15.05.1/ar71xx/generic/packages/management</div><div class="line">src/gz chaos_calmer_packages http://openwrt.proxy.ustclug.org/chaos_calmer/15.05.1/ar71xx/generic/packages/packages</div><div class="line">src/gz chaos_calmer_routing http://openwrt.proxy.ustclug.org/chaos_calmer/15.05.1/ar71xx/generic/packages/routing</div><div class="line">src/gz chaos_calmer_telephony http://openwrt.proxy.ustclug.org/chaos_calmer/15.05.1/ar71xx/generic/packages/telephony</div><div class="line">src imagebuilder file:packages</div></pre></td></tr></table></figure>
<h2 id="安装-make-的依赖"><a href="#安装-make-的依赖" class="headerlink" title="安装 make 的依赖"></a>安装 make 的依赖</h2><p>Debian/Ubuntu</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">apt-get install subversion build-essential libncurses5-dev zlib1g-dev gawk git ccache gettext libssl-dev xsltproc wget</div></pre></td></tr></table></figure>
<p>CentOS/RHEL</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">yum install subversion git gawk gettext ncurses-devel zlib-devel openssl-devel libxslt wget</div><div class="line">yum group install <span class="string">"Development Tools"</span></div></pre></td></tr></table></figure>
<h2 id="修改-Makefile"><a href="#修改-Makefile" class="headerlink" title="修改 Makefile"></a>修改 Makefile</h2><figure class="highlight makefile"><table><tr><td class="code"><pre><div class="line">	<span class="variable">$(OPKG)</span> update || true; \</div><div class="line">	fi</div><div class="line">	<span class="variable">$(MAKE)</span> package_install</div><div class="line">	# 添加以下 1 行，注意缩进，用 tab</div><div class="line">	sed -i '/proto_run_command/i username=`echo -e <span class="string">"$$username"</span>`' <span class="string">"$(TARGET_DIR)/lib/netifd/proto/ppp.sh"</span></div><div class="line">ifneq ($(USER_FILES),)</div><div class="line">	<span class="variable">$(MAKE)</span> copy_files</div><div class="line">endif</div></pre></td></tr></table></figure>
<p>不明白为什么要这样做的同学，请先看 <a href="/2016/10/08/drcom/">Drcom 折腾记录</a>。</p>
<h2 id="配置文件的准备"><a href="#配置文件的准备" class="headerlink" title="配置文件的准备"></a>配置文件的准备</h2><p>新建一个 <code>files</code> 目录，将所需的文件放在相应目录，以制作带有自定义文件的固件。</p>
<p>Drcom 认证需要的文件（可以从 <a href="/2016/10/08/drcom/">Drcom 折腾记录</a> 获取）：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">files/</div><div class="line">├── etc/</div><div class="line">│   ├── drcom.conf</div><div class="line">│   └── hotplug.d/</div><div class="line">│       └── iface/</div><div class="line">│           └── 99-drcom</div><div class="line">└── usr/</div><div class="line">    └── bin/</div><div class="line">        └── drcom</div></pre></td></tr></table></figure>
<p>可以用 <code>scp</code> 备份其它配置文件：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">mkdir -p files/etc/config</div><div class="line">scp root@192.168.1.1:<span class="string">"/etc/config/network /etc/config/luci /etc/config/wireless /etc/config/firewall"</span> files/etc/config/</div><div class="line">scp root@192.168.1.1:<span class="string">"/etc/sysupgrade.conf"</span> files/etc/</div></pre></td></tr></table></figure>
<p>也可以登录 luci，系统 -&gt; 备份 / 升级 -&gt; 生成备份，获得配置文件的压缩包。</p>
<h2 id="编译固件"><a href="#编译固件" class="headerlink" title="编译固件"></a>编译固件</h2><p>语法：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">make image PROFILE=XXX PACKAGES=<span class="string">"pkg1 pkg2 pkg3 -pkg4 -pkg5 -pkg6"</span> FILES=files/</div></pre></td></tr></table></figure>
<ul>
<li>PROFILE：含有要编译的型号的配置；通过执行 <code>make info</code>，查看可用的选项。</li>
<li>PACKAGES：要编译进固件的包</li>
<li>FILES：包含要添加到固件的文件的文件夹</li>
</ul>
<p>现在执行下面的命令的可以编译出自带 Drcom 的固件。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><div class="line">make image PROFILE=<span class="string">"GLINET"</span> PACKAGES=<span class="string">"luci luci-i18n-base-zh-cn python-light python-logging python-openssl python-codecs"</span> FILES=files/</div></pre></td></tr></table></figure>
<p>所得固件在 <code>bin/ar71xx</code>。</p>
</section></article></div></main><footer class="site-footer"><section><small>&copy; 2015-2017
 dgeibi <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a></small></section><section><small>Powered by <a href="https://hexo.io">Hexo</a>. Theme by <a href="https://github.com/dgeibi">dgeibi</a>.</small></section></footer><a class="back-to-top" data-js-backtotop href="#" title="Back to top">&uarr;</a></body></html>